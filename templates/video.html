<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calorie Calculation of Fruits & Vegetables</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .bg-custom {
            background-image: url('{{ url_for("static", filename="img/BG_img.jpeg") }}');
            background-size: cover;
            background-position: center;
            background-repeat: no-repeat;
        }
    </style>
    <!-- <script src="{{ url_for('static', filename='js/script.js') }}"></script> -->
</head>

<body class="bg-custom bg-cover bg-center bg-no-repeat font-sans">
    <div class="bg-black bg-opacity-50 h-lvh">
        <!-- Header -->
        <div class="w-full bg-red-600 py-4 flex items-center justify-center relative">
            <a href="{{ url_for('welcome') }}" class="absolute left-8 text-white hover:text-gray-400 focus:outline-none focus:ring-2 focus:ring-gray-500 p-2 transition-colors duration-500">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" class="h-8 w-8 fill-current">
                    <path
                        d="M459.5 440.6c9.5 7.9 22.8 9.7 34.1 4.4s18.4-16.6 18.4-29l0-320c0-12.4-7.2-23.7-18.4-29s-24.5-3.6-34.1 4.4L288 214.3l0 41.7 0 41.7L459.5 440.6zM256 352l0-96 0-128 0-32c0-12.4-7.2-23.7-18.4-29s-24.5-3.6-34.1 4.4l-192 160C4.2 237.5 0 246.5 0 256s4.2 18.5 11.5 24.6l192 160c9.5 7.9 22.8 9.7 34.1 4.4s18.4-16.6 18.4-29l0-64z" />
                </svg>
            </a>
            
            

            <h1 class="text-3xl text-white font-bold text-center">
                Calorie Calculation Of Fruits & Vegetables
            </h1>
        </div>

        <!-- Main Content Wrapper -->
        <div class="max-w-7xl mx-auto p-8 mt-20">
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8">

                <!-- Video  -->
                <div
                    class="col-span-1 bg-gradient-to-r from-gray-900 via-gray-800 to-gray-900 rounded-lg shadow-xl p-6 flex flex-col items-center justify-center">
                    <h2 class="text-3xl font-semibold text-white mb-6 text-center">
                        Live Video Feed
                    </h2>
                    <div class="flex items-center justify-center h-full relative w-full">
                        <div class="relative rounded-lg overflow-hidden border-4 border-gray-700 shadow-lg w-full h-full flex items-center justify-center"
                            style="box-shadow: 0 0 20px rgba(255, 255, 255, 0.2);">
                            <img id="video-feed" src="" alt="video" class="w-full h-full rounded-lg hidden"
                                style="border: 2px solid black;">
                            <!-- placeholder -->
                            <div id="Placeholder" class="absolute inset-0 flex items-center justify-center">
                                <div class="text-center">
                                    <p class="text-gray-400 text-lg font-semibold">No Video Feed Available</p>
                                    <p class="text-gray-500">Please click "Start" to begin streaming</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>


                <!-- Object Detection -->
                <div class="col-span-1 bg-white bg-opacity-90 rounded-lg shadow-lg p-6" id="no-video-placeholder">
                    <h2 class="text-xl font-semibold bg-red-600 text-white py-2 px-4 rounded text-center mb-4">
                        Object Details
                    </h2>
                    <div class="">
                        <label class="block text-gray-700 text-lg mb-2">Name of the object:</label>
                        <div id="current-detection"
                            class="bg-white rounded p-2 text-center border border-gray-300 text-lg">No detection</div>
                    </div>
                    
                    <div class="container mx-auto p-2">
                        <h2 class="text-2xl font-semibold mb-2 text-center">Nutritional Information of Fruits &
                            Vegetables</h2>
                        <div class="overflow-x-auto">
                            <table class="table-auto w-full bg-white shadow-md rounded-lg">
                                <tbody>
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-1 px-2 text-left">Calories (kcal)</td>
                                        <td class="py-1 px-2 text-left" id="calorie">0</td>
                                    </tr>
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-1 px-2 text-left">Protein (g)</td>
                                        <td class="py-1 px-2 text-left" id="protein">0</td>
                                    </tr>
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-1 px-2 text-left">Carbohydrates (g)</td>
                                        <td class="py-1 px-2 text-left" id="carbohydrate">0</td>
                                    </tr>
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-1 px-2 text-left">Fat (g)</td>
                                        <td class="py-1 px-2 text-left" id="fat">0</td>
                                    </tr>
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-1 px-2 text-left">Fiber (g)</td>
                                        <td class="py-1 px-2 text-left" id="fiber">0</td>
                                    </tr>
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-1 px-2 text-left">Sugar (g)</td>
                                        <td class="py-1 px-2 text-left" id="sugar">0</td>
                                    </tr>
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-1 px-2 text-left">Vitamin C (mg)</td>
                                        <td class="py-1 px-2 text-left" id="vitaminC">0</td>
                                    </tr>
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-1 px-2 text-left">Vitamin A (µg)</td>
                                        <td class="py-1 px-2 text-left" id="vitaminA">0</td>
                                    </tr>
                                    <tr class="border-b border-gray-200 hover:bg-gray-100">
                                        <td class="py-1 px-2 text-left">Potassium (mg)</td>
                                        <td class="py-1 px-2 text-left" id="potassium">0</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <div class="flex justify-center gap-4">
                        <button id="startBtn" onclick="startStream()"
                            class="bg-green-600 text-white py-2 px-4 rounded hover:bg-green-700 mb-4">Start</button>
                        <button id="stopBtn" onclick="stopStream()"
                            class="bg-red-600 text-white py-2 px-4 rounded hover:bg-red-700 mb-4">Stop</button>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <script>
        const calorie = document.getElementById('calorie');
        const protein = document.getElementById('protein');
        const carbohydrate = document.getElementById('carbohydrate');
        const fat = document.getElementById('fat');
        const sugar = document.getElementById('sugar');
        const fiber = document.getElementById('fiber');
        const potassium = document.getElementById('potassium');
        const vitaminA = document.getElementById('vitaminA');
        const vitaminC = document.getElementById('vitaminC');


function startStream() {
    try {
        document.getElementById('video-feed').classList.remove('hidden');
        document.getElementById('Placeholder').classList.add('hidden');

        document.getElementById('video-feed').src = "/video_feed";
        document.getElementById('startBtn').disabled = true;
        document.getElementById('stopBtn').disabled = false;


        // Start polling detection results
        pollDetections();

    } catch (error) {
        console.error('Error accessing webcam:', error);
        alert('Could not access the webcam. Please allow camera access.');
    }
}

function stopStream() {

    document.getElementById('video-feed').src = null;
    document.getElementById('stopBtn').disabled = true;
    document.getElementById('startBtn').disabled = false;
    document.getElementById('video-feed').classList.add('hidden');
    document.getElementById('Placeholder').classList.remove('hidden');
    document.getElementById('current-detection').textContent = "No detection";


}

function pollDetections() {
    fetch('/current_detection')
        .then(response => response.json())
        .then(data => {
            const detectionDisplay = document.getElementById('current-detection');
            if (data) {
                try {
                    data = JSON.parse(data);
                } catch (error) {
                    data = {
                        "label": "No detection",
                        "score": 0,
                        "nutrition": {}
                    }
                }
                // console.log(data);
                detectionDisplay.textContent = `${data.label}: ${data.score}%`;
                if (data.label !== "No detection") {
                    calorie.textContent = data.nutrition["Calories (kcal)"];
                    protein.textContent = data.nutrition["Protein (g)"];
                    carbohydrate.textContent = data.nutrition["Carbohydrates (g)"];
                    fat.textContent = data.nutrition["Fat (g)"];
                    sugar.textContent = data.nutrition["Sugar (g)"];
                    fiber.textContent = data.nutrition["Fiber (g)"];
                    potassium.textContent = data.nutrition["Potassium (mg)"];
                    vitaminA.textContent = data.nutrition["Vitamin A (µg)"];
                    vitaminC.textContent = data.nutrition["Vitamin C (mg)"];
                } else {
                    calorie.textContent = "0";
                    protein.textContent = "0";
                    carbohydrate.textContent = "0";
                    fat.textContent = "0";
                    sugar.textContent = "0";
                    fiber.textContent = "0";
                    potassium.textContent = "0";
                    vitaminA.textContent = "0";
                    vitaminC.textContent = "0";
                }
            } else {
                detectionDisplay.textContent = "No detection";
            }
        })
        .catch(error => {
            console.error('Error:', error);
        });

    // Poll every second if video feed is active
    if (document.getElementById('video-feed').src) {
        setTimeout(pollDetections, 1000);
    }
}

    </script>
    
</body>

</html>